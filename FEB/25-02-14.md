# TIL 

## 날짜: 2025-02-14 (금요일)

### 스크럼
- 학습 목표 1 : 딥다이브 - JWT 토큰이 탈취 당했을 때 해결할 수 있는 방법 

### 새로 배운 내용
### 🥎 JWT 토큰이 탈취 당했을 때 해결할 수 있는 방법 
```
✔️ JWT 는 애플리케이션 간의 정보 교환에 사용되는, JSON 형식의 자체 포함형 토큰이다. 

- Token 은 사용자 인증, 데이터 전송, 설정 정보 등을 나타내는데 사용되는 작은 정보 조각이다.
- 자체포함형 은 JWT 안에 필요한 모든 정보가 담겨 있음을 의미한다.
- JWT는 클라이언트에 저장되며 요청마다 서버에 전달된다. 서버는 JWT의 유효성을 검사해 별도의 데이터베이스 조회 없이 사용자 인증과 권한 확인을 할 수 있다.

⇒ 인증과 인가를 위해 JWT를 사용한다. JWT에 사용자 정보가 담겨 있으며, 요청을 보낼 때 사용자를 증명하는 “출입증” 같은 역할.
```
#### 📍 주제 1: JWT 탈취 방법: JWT 토큰은 어떻게 탈취당하는가? 
- JWT를 이용한 인증&인가 과정: 
  - 클라이언트가 로그인 요청을 보낸다.
  - 서버에서 JWT를 만들고, 클라이언트에 전송한다. 🚨
  - 클라이언트는 JWT를 저장하고, 요청을 보낼 때 JWT를 포함해 전달한다. 🚨
  - 서버는 JWT의 유효성을 검사하고, 권한 검사 후, 응답한다.
- **서버→클라이언트 전송 과정**: **탈취** 
    - 네트워크 공격
      - MITM(Man-in-the-Middle; 중간자 공격): 네트워크에서 JWT를 **가로챔** (소매치기)
      - 패킷 스니핑: HTTP 요청을 **감청** (몰래 엿들음)
- **클라이언트→서버 요청 과정**: **탈취** 
    - 네트워크 공격
    - XSS(크로스 사이트 스크립팅): 공격자가 웹사이트에 **악성 스크립트**를 삽입해 브라우저의 로컬 스토리지/세션 스토리지에 저장된 JWT를 탈취 (직접 들어가서 가져옴 =도둑)
    - CSRF(사이트 간 요청 위조): JWT를 쿠키에 저장하는 경우, 공격자가 **서버인 척** 공격자의 사이트에 요청을 보내도록 유도하면 자동으로 JWT가 포함되어 전송됨. (사용자를 속여 가져오게 함)

#### 📍 주제 2: 탈취 당했을 때의 문제점 
- 토큰을 이용해 인증/인가된 사용자인 척 할 수 있다는 것이 문제
- 또한 토큰의 무상태성 덕분에 서버는 토큰의 상태를 저장하지 않으며 제어권이 없다. 따라서 서버는 토큰만으로 해커를 구분할 수 없고, 토큰이 탈취 당했을 때 토큰을 즉시 만료시키는 등 유효성을 제어할 수 없다. 

#### 📍 주제 3: 탈취 당했을 때 해결할 수 있는 방법
1. 탈취 예방하는 방법
   - Access Token + Refresh Token : 인증을 위한 토큰, Access Token이 만료되면 재발급받을 때 사용하는 토큰 두 개를 사용한다. (stateless 인증 + stateful 관리)
   - HttpOnly 쿠키와 함께 사용하기
   - 짧은 유효기간 설정
   - 리프레시 토큰 회전 
2. 탈취 확인하는 방법
   - Access Token 유효 기간 짧게 해, 만료된 JWT 사용 감지
   - JWT 사용 시 이상한 IP 또는 User-Agent(브라우저) 감지
   - Refresh Token 목록을 관리하고 사용 이력을 추적
   - 새로운 로그인이 평소와 다른지 확인
3. 탈취 해결하는 방법
   - 의심스러운 활동이 감지되면, Refresh Token과 JWT를 무효화한다.
     - Refresh Token을 삭제한다.
     - JWT를 블랙리스트에 추가한다. 토큰id를 따로 저장해 차단할 수도 있다. (차단할 jwt만 저장)
   - 사용자의 모든 세션을 강제로 만료시켜 JWT를 더 이상 사용할 수 없도록 한다.
   - 2단계 인증(2FA) 활성화 강제 적용
4. (추가) Refresh Token 저장소로 Redis를 사용하는 이유
   - Redis는 키-값 쌍의 구조를 가진 NoSQL DBMS이다.
   - 액세스 속도가 빨라서 Refresh Token 발급 시 병목이 되지 않는다.
   - 데이터의 유효기간을 지정할 수 있다. → 스케줄러를 이용해 토큰을 만료 처리하거나 제거해주지 않아도 된다.

### 오늘의 도전 과제와 해결 방법
- 도전 과제 1: JWT 토큰이 탈취 당했을 때 해결할 수 있는 방법에 대한 딥다이브
  - JWT가 어떻게 탈취되는지, 탈취되었을 때 문제점이 무엇인지에 대해 먼저 정리해보았다.
  - 탈취를 예방하는 방법, 확인하는 방법, 해결하는 방법으로 나뉘어 각 접근 방법에 대해 정리하였다.

### 오늘의 회고
- 요약 정리: JWT는 사용자 인증에 사용되는 토큰으로, 서버와 클라이언트의 전달 과정과 클라이언트의 보관 과정에서 탈취가 발생할 수 있다. 토큰이 탈취 당할 경우 해커는 사용자를 가장할 수 있으며, 서버 측에서 이를 감지하고 제어하는 것이 어렵다. 따라서 토큰 탈취를 예방하고, 감지하고, 해결하는 방법이 필요하다. 토큰 탈취를 예방하기 위해서 Access Token과 Refresh Token 두 개를 사용하여 토큰을 자주 갱신하도록 한다. 또한 사용자 활동과 토큰 사용 시 의심스러운 활동을 감지해 토큰의 탈취 여부를 확인한다. 토큰이 탈취되었을 때는 Refresh Token을 삭제하고 서버의 블랙리스트를 통해 Access Token을 무효화할 수 있다. 
- JWT의 탈취 문제에 대해 알아보기 위해 단계적으로 접근하고 이해하였다. 스스로 모르는 부분을 찾아보고 시각적으로 구조화하고 예쁘게 정리하는 과정에서 배운 내용들을 내 것으로 만들 수 있었다. 이번 주제가 너무 재밌어서 공부하고 정리하는 과정, 발표하는 것이 즐거웠다. :) 
  
### 참고 자료 및 링크
- [✏️ 노션 정리](https://mellow-sailor-ec6.notion.site/3-19a258f8f61980c1976bd61c2925295d?pvs=4)
